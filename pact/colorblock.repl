(env-data {
  "ns": "free",
  "cb-admin-keyset": {"keys": ["admin"]},
  "alice-keyset": {"keys": ["alice"]},
  "bob-keyset": {"keys": ["bob"]},
  "lucy-keyset": {"keys": ["lucy"]},
  "jack-keyset": {"keys": ["jack"]},
  "upgrade": false
})

(begin-tx)
;(define-namespace "free" (read-keyset 'cb-admin-keyset) (read-keyset 'cb-admin-keyset))
(load "coin/fungible-v1.pact")
(load "coin/coin.pact")
(load "non-fungible-v1.pact")
(load "colorblock.pact")
(verify 'colorblock)
(commit-tx)

(begin-tx)

;; -----------------------------
;; Account
;; -----------------------------

;
; create account in COIN module
;
(coin.create-account "admin" (read-keyset "cb-admin-keyset"))
(coin.create-account "bob" (read-keyset "bob-keyset"))
(coin.create-account "alice" (read-keyset "alice-keyset"))
(coin.create-account "lucy" (read-keyset "lucy-keyset"))
(coin.create-account "jack" (read-keyset "jack-keyset"))

;
; create account in COLORBLOCK module
;
(env-sigs [{"key": "admin", "caps": []}])
(expect
  "Create successfully for the first time"
  "Write succeeded"
  (colorblock.create-account-maybe "admin" (read-keyset "cb-admin-keyset"))
)
(expect 
  "Failed for the second time"
  "Account already exists" 
  (colorblock.create-account-maybe "admin" (read-keyset "cb-admin-keyset"))
)
(expect-failure 
  "Creating will fail when keyset diffs with the one of coin account" 
  "Guard must match the same account of KDA"
  (colorblock.create-account-maybe "alice" (read-keyset "bob-keyset"))
)
(env-sigs [{"key": "bob", "caps": []}])
(expect-failure 
  "Creating will fail when keyset diffs with the one of coin account" 
  "Guard must match the same account of KDA"
  (colorblock.create-account-maybe "alice" (read-keyset "bob-keyset"))
)
(expect
  "Create successfully for directly creating at first time"
  "Write succeeded"
  (colorblock.create-account "bob" (read-keyset "bob-keyset"))
)
(expect-failure 
  "account exists" 
  "row found"
  (colorblock.create-account "bob" (read-keyset "bob-keyset"))
)
(expect-failure 
  "Creating will fail when coin account not exists" 
  "row not found"
  (colorblock.create-account-maybe "nonce" (read-keyset "bob-keyset"))
)
(env-sigs [{"key": "lucy", "caps": []}])
(expect
  "Create successfully for directly creating at first time"
  "Write succeeded"
  (colorblock.create-account "lucy" (read-keyset "lucy-keyset"))
)

;
; read account info
;
(expect 
  "Get default username of account"
  "bob"
  (at 'username (colorblock.details "bob"))
)
(expect 
  "Get default username of account"
  "bob"
  (at 'account (colorblock.details "bob"))
)
(expect-failure
  "Get error when fetching account that not exists"
  "row not found"
  (colorblock.details "alice")
)
(env-sigs [{"key": "nonce", "caps": []}])
(expect 
  "No requirement for sig"
  "bob"
  (at 'username (colorblock.details "bob"))
)

(commit-tx)
(begin-tx)

(env-sigs [{"key": "bob", "caps": [(colorblock.OWN-ACCOUNT "bob")]}])
(expect 
  "Create item for testing creating item"
  "Write succeeded"
  (colorblock.create-item "my-title" ["my-tag"] "my-desc" 
    "aaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccdddddd"
    4 4 1 [1.0] "bob")
)

(commit-tx)
(begin-tx)

;
; query about account
;
(expect
  "get right balance of specific account"
  1
  (colorblock.balance-of "bob")
)
(expect
  "get right balance of specific account"
  0
  (colorblock.balance-of "admin")
)
(let 
  (
    (
    key (at 'id (at 0 (colorblock.items-of "bob")))
    )
  )
  (expect
    "get right owner of specific item"
    "bob"
    (colorblock.owner-of key)
  )
)

;
; rotate account
;
(env-sigs [
  {"key": "lucy", "caps": []}
  {"key": "admin", "caps": []},
])
(expect-failure
  "Rotating will fail as there's no required capability"
  "Managed capability not installed"
  (colorblock.rotate "lucy" (read-keyset "cb-admin-keyset"))
)



;; -----------------------------
;; Item
;; -----------------------------

(env-sigs [{"key": "admin", "caps": [(colorblock.OWN-ACCOUNT "admin")]}])

;
; create item
;

(expect-failure 
  "Creating will fail as title is blank" 
  "Title can not be empty"
  (colorblock.create-item "" ["tag"] "" "a" 1 1 1 [1.0] "admin")
)
(expect-failure 
  "Creating will fail as tag length limit exceeded" 
  "Illegal tags: length larger than"
  (colorblock.create-item "title" ["asdasdasdasdasdsadasddddddddddddddddddddddd"] "description" "a" 1 1 1 [] "admin")
)
(expect-failure 
  "Creating will fail as tag count limit exceeded" 
  "Illegal tags: more than"
  (colorblock.create-item "title" ["sds" "sdsad" "sd" "sds" "sdsad" "sd" "sds" "sdsad" "sd" "sds" "sdsad" "sd" "sds" "sdsad" "sd" "sds" "sdsad" "sd"] 
   "description" "a" 1 1 1 [] "admin")
)
(expect-failure 
  "Creating will fail as description length limit exceeded" 
  "Illegal description: length larger than"
  (colorblock.create-item 
    "title" 
    ["sds" "sds" "sdsad" "sd"] 
    "description-aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" 
    "a" 1 1 1 [] 
    "admin"
  )
)
(expect-failure 
  "Creating will fail as cells length is wrong" 
  "the length of cells is not correct"
  (colorblock.create-item "title" ["tag"] "description" "aaaaaa" 1 2 1 [] "admin")
)
(expect-failure
  "Creating will fail as cells length is wrong" 
  "the length of cells is not correct"
  (colorblock.create-item "title" ["tag"] "description" "aaaaaa" 1 1 3 [] "admin")
)
(expect-failure
  "Creating will fail as rows length is wrong" 
  "the number of rows in each frame expected in range of"
  (colorblock.create-item "title" ["tag"] "description" "aaaaaaaaaaaaaaaaaaaaaaaa" 1 4 1 [] "admin")
)
(expect-failure
  "Creating will fail as rows length is wrong" 
  "the number of rows in each frame expected in range of"
  (colorblock.create-item "title" ["tag"] "description" "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
  257 1 1 [] "admin")
)
(expect-failure
  "Creating will fail as cols length is wrong" 
  "the number of cols in each frame expected in range of"
  (colorblock.create-item "title" ["tag"] "description" "aaaaaaaaaaaaaaaaaaaaaaaa" 4 1 1 [] "admin")
)
(expect-failure
  "Creating will fail as cols length is wrong" 
  "the number of cols in each frame expected in range of"
  (colorblock.create-item "title" ["tag"] "description" "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
    4 257 1 [] "admin")
)
(expect-failure
  "Creating will fail as frames length is wrong" 
  "the number of frames expected in range of"
  (colorblock.create-item "title" ["tag"] "description" "" 
    4 4 0 [] "admin")
)
(expect-failure
  "Creating will fail as frames length is wrong" 
  "the number of frames expected in range of"
  (colorblock.create-item "title" ["tag"] "description" "aaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccdddddd" 
    4 4 17 [] "admin")
)
(expect-failure
  "Creating will fail as intervals count not equal to frame"
  "Interval count must equal to the number of frames"
  (colorblock.create-item "title" ["tag"] "description" "aaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccdddddd" 
    4 4 1 [0.5 0.5] "admin")
)
(expect-failure
  "Creating will fail as there's non-hex character"
  "not a digit"
  (colorblock.create-item "title" ["tag"] "description" "Taaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccdddddd" 
    4 4 1 [1.0] "admin")
)

(commit-tx)
(begin-tx)
(env-sigs [{"key": "admin", "caps": [(colorblock.OWN-ACCOUNT "admin")]}])

(expect-failure
  "Creating will fail as Key doesn't match"
  "Managed capability not installed"
  (colorblock.create-item "title" ["tag"] "description" "aaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccdddddd" 
    4 4 1 [1.0] "bob")
)
(expect
  "Creating will success"
  "Write succeeded"
  (colorblock.create-item "title" ["tag"] "description" "aaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccdddddd" 
    5 4 1 [1.0] "admin")
)

(commit-tx)
(begin-tx)
(env-sigs [{"key": "admin", "caps": [(colorblock.OWN-ACCOUNT "admin")]}])

(expect
  "Creating will success"
  "Write succeeded"
  (colorblock.create-item "title" ["tag"] "description"
    "aaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccddddddaaaaaabbbbbbccccccdddddd" 
    4 4 2 [0.5 0.5] "admin"
  )
)


(commit-tx)
(begin-tx)

;
; query item
;
(expect
  "get right num of items"
  3
  (length (colorblock.all-items))
)


;; -----------------------------
;; Transaction
;; -----------------------------

(expect-failure
  "Tanfering will fail as there's no required capability"
  "Managed capability not installed"
  (colorblock.transfer "admin" "bob" "123")
)
(env-sigs [{"key": "admin", "caps": [(colorblock.TRANSFER "" "bob" "123")]}])
(expect-failure
  "Tanfering will fail as sender is blank"
  "Empty identifier"
  (colorblock.transfer "" "bob" "123")
)
(env-sigs [{"key": "admin", "caps": [(colorblock.TRANSFER "admin" "" "123")]}])
(expect-failure
  "Tanfering will fail as receiver is blank"
  "Empty identifier"
  (colorblock.transfer "admin" "" "123")
)
(env-sigs [{"key": "admin", "caps": [(colorblock.TRANSFER "admin" "bob" "")]}])
(expect-failure
  "Tanfering will fail as item id is blank"
  "Empty identifier"
  (colorblock.transfer "admin" "bob" "")
)

(commit-tx)
(begin-tx)
(env-sigs [{"key": "admin", "caps": [
  (colorblock.TRANSFER "admin" "bob" "123"),
  (colorblock.OWN-ACCOUNT "admin")]}
])

(expect-failure
  "Tanfering will fail as there's no such item"
  "row not found"
  (colorblock.transfer "admin" "bob" "123")
)
(env-sigs [{"key": "admin", "caps": [(colorblock.TRANSFER "admin" "bob" "123")]}])
(expect-failure
  "Tanfering will fail as arguments in caps must be consistent with function"
  "Managed capability not installed"
  (colorblock.transfer "admin" "bob" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")
)

(commit-tx)
(begin-tx)
(env-sigs [{"key": "admin", "caps": [
  (colorblock.TRANSFER "admin" "bob" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg"),
  (colorblock.OWN-ACCOUNT "admin")]}
])

(expect
  "Tanfering will success"
  "Write succeeded"
  (colorblock.transfer "admin" "bob" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")
)

(commit-tx)
(begin-tx)
(env-sigs [{"key": "admin", "caps": [
  (colorblock.TRANSFER "admin" "bob" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg"),
  (colorblock.OWN-ACCOUNT "admin")]}
])

(expect-failure
  "Tanfering will fail as sender must be owner of item"
  "Sender is not owner"
  (colorblock.transfer "admin" "bob" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")
)
(env-sigs [{"key": "admin", "caps": [(colorblock.TRANSFER "bob" "alice" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")]}])
(expect-failure
  "Tanfering will fail as signer doesn't match with sender in caps"
  "Managed capability not installed"
  (colorblock.transfer "bob" "alice" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")
)
(env-sigs [{"key": "bob", "caps": [
  (colorblock.TRANSFER "bob" "alice" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg"),
  (colorblock.OWN-ACCOUNT "bob")
]}])
(expect-failure
  "Tanfering will fail as receiver doesn't exist"
  "row not found"
  (colorblock.transfer "bob" "alice" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")
)
(env-sigs [{"key": "bob", "caps": [(colorblock.TRANSFER "bob" "admin" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")]}])
(expect
  "Owner is belong to old account"
  "bob"
  (colorblock.owner-of "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")
)

(env-sigs [{"key": "bob", "caps": [
  (colorblock.TRANSFER "bob" "admin" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg"),
  (colorblock.OWN-ACCOUNT "bob")
]}])

(expect
  "Tanfering will fail as sender must be owner of item"
  "Write succeeded"
  (colorblock.transfer "bob" "admin" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")
)
(expect
  "Owner is swithed to new account"
  "admin"
  (colorblock.owner-of "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")
)

(env-sigs [{"key": "admin", "caps": [
  (colorblock.TRANSFER "admin" "alice" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg"),
  (colorblock.OWN-ACCOUNT "admin")
]}])

(expect
  "Tanfer successfuly when add creating phase"
  "Write succeeded"
  (colorblock.transfer-create "admin" "alice" (read-keyset "alice-keyset") "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")
)
(expect
  "Owner is swithed to new account"
  "alice"
  (colorblock.owner-of "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")
)
(expect
  "Account is created after transfer-create"
  "alice"
  (at 'username (colorblock.details "alice"))
)
(env-sigs [
  {"key": "alice", "caps": [
    (colorblock.TRANSFER "alice" "bob" "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg"),
    (colorblock.OWN-ACCOUNT "alice")
  ]},
  {"key": "bob", "caps": []}
])
(expect-failure
  "Tanfering will fail as receiver already exists"
  "row found for key bob"
  (colorblock.transfer-create "alice" "bob" (read-keyset "bob-keyset") "GKRDMtA_5XDuxjQUnoGPOdh4EwOGLUw3EClnj39PAkg")
)


